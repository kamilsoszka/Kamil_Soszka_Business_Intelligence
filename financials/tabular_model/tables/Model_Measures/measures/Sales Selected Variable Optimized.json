{
  "name": "Sales Selected Variable Optimized",
  "expression": [
    "",
    "/*",
    "    Business Goal: This measure creates a comprehensive text label that combines:",
    "    1. A description of actively selected filters (Segment and Product)",
    "    2. Key performance indicators including:",
    "       - Percentage share of annual total sales",
    "       - Year-over-Year change with arrow symbol",
    "       - Previous year sales value",
    "       - Absolute YoY change in millions",
    "    The output format is: \"Selected Segment: X / Selected Product: Y (↑ | PY: 1.50M | YoY: 0.25M | 15.25%)\"",
    "    This provides complete context about both the filter selection and sales performance in a single text field.",
    "*/",
    "VAR _Segment =",
    "    /*",
    "        SELECTEDVALUE: Returns the value of the specified column when there's only one value",
    "        in the current filter context. If multiple values exist, returns BLANK().",
    "        This captures which Segment is currently selected in report filters/slicers.",
    "    */",
    "    SELECTEDVALUE ( financials[Segment] )",
    "VAR _Product =",
    "    /*",
    "        SELECTEDVALUE: Captures the currently selected Product from filters/slicers.",
    "        Used to build descriptive text about the current filter context.",
    "    */",
    "    SELECTEDVALUE ( financials[Product] )",
    "",
    "// 1. Performance Calculations (IFERROR Stabilization):",
    "VAR Current_Sales =",
    "    /*",
    "        IFERROR: Wraps the base Sales measure to handle any calculation errors gracefully.",
    "        Returns BLANK() instead of an error, making the measure more robust.",
    "    */",
    "    IFERROR ( [Sales], BLANK () )",
    "VAR Grand_Total_Sales_In_Year =",
    "    /*",
    "        CALCULATE with REMOVEFILTERS and ALL: Calculates the total Sales for the entire dataset.",
    "        - REMOVEFILTERS(financials): Removes all filters from the financials table",
    "        - ALL('Dates Optimized'): Removes all filters from the dates table",
    "        This gives the grand total Sales for context, used to calculate percentage share.",
    "    */",
    "    CALCULATE (",
    "        IFERROR ( [Sales], BLANK () ),",
    "        REMOVEFILTERS ( financials ),",
    "        ALL ( 'Dates Optimized' )",
    "    )",
    "VAR Previous_Year_Sales =",
    "    /*",
    "        CALCULATE with SAMEPERIODLASTYEAR: Calculates Sales for the same period in the previous year.",
    "        Standard time intelligence pattern for YoY comparisons.",
    "    */",
    "    CALCULATE (",
    "        IFERROR ( [Sales], BLANK () ),",
    "        SAMEPERIODLASTYEAR ( 'Dates Optimized'[Date] )",
    "    )",
    "",
    "// 2. Change Calculations and Formatting",
    "VAR Share_Percentage =",
    "    /*",
    "        DIVIDE: Safely calculates the percentage share of current Sales relative to grand total.",
    "        Returns BLANK() if division by zero occurs.",
    "    */",
    "    DIVIDE ( Current_Sales, Grand_Total_Sales_In_Year, BLANK () )",
    "VAR YoY_Absolute_Change =",
    "    /*",
    "        COALESCE: Replaces BLANK values with 0 to ensure correct arithmetic operations.",
    "        Calculates the absolute change in Sales compared to previous year.",
    "    */",
    "    COALESCE ( Current_Sales, 0 ) - COALESCE ( Previous_Year_Sales, 0 )",
    "VAR YoY_Absolute_Change_Millions =",
    "    /*",
    "        DIVIDE: Converts the absolute change to millions for better readability.",
    "        Returns BLANK() if division fails.",
    "    */",
    "    DIVIDE ( YoY_Absolute_Change, 1000000, BLANK () )",
    "VAR Previous_Sales_Millions =",
    "    /*",
    "        DIVIDE: Converts previous year Sales to millions for consistent formatting.",
    "    */",
    "    DIVIDE ( Previous_Year_Sales, 1000000, BLANK () )",
    "",
    "// 3. Text Logic (Filters/Symbols):",
    "VAR Arrow_Symbol =",
    "    /*",
    "        Nested IF statements to determine the appropriate arrow symbol:",
    "        - Up arrow (↑) for increase in Sales (favorable)",
    "        - Down arrow (↓) for decrease in Sales (unfavorable)",
    "        - BLANK() for no change",
    "        Note: This correctly shows upward arrow for sales growth (positive change).",
    "    */",
    "    IF (",
    "        YoY_Absolute_Change > 0,",
    "        UNICHAR ( 11165 ), // Up arrow for sales increase (good)",
    "        IF ( YoY_Absolute_Change < 0, UNICHAR ( 11167 ), BLANK () ) // Down arrow or BLANK",
    "    )",
    "VAR Segment_Text_Fragment =",
    "    /*",
    "        ISFILTERED: Returns TRUE if the specified column has an active filter applied.",
    "        Creates text only when the Segment filter is actively used.",
    "    */",
    "    IF (",
    "        ISFILTERED ( financials[Segment] ),",
    "        \"Selected Segment: \" & _Segment,",
    "        BLANK ()",
    "    )",
    "VAR Product_Text_Fragment =",
    "    /*",
    "        ISFILTERED: Checks if Product column has active filters.",
    "        Creates descriptive text only when Product filter is applied.",
    "    */",
    "    IF (",
    "        ISFILTERED ( financials[Product] ),",
    "        \"Selected Product: \" & _Product,",
    "        BLANK ()",
    "    )",
    "VAR Separator_Text_Filter =",
    "    /*",
    "        AND with NOT ISBLANK: Adds a separator \" / \" only when both Segment and Product",
    "        have active filters and both text fragments are non-blank.",
    "    */",
    "    IF (",
    "        AND (",
    "            NOT ISBLANK ( Segment_Text_Fragment ),",
    "            NOT ISBLANK ( Product_Text_Fragment )",
    "        ),",
    "        \" / \",",
    "        BLANK ()",
    "    )",
    "VAR Filter_Texts =",
    "    /*",
    "        TRIM and COALESCE: Combines all filter-related text fragments into a single string.",
    "        COALESCE replaces BLANK values with empty strings, then TRIM removes extra spaces.",
    "    */",
    "    TRIM (",
    "        COALESCE ( Segment_Text_Fragment, \"\" ) & COALESCE ( Separator_Text_Filter, \"\" )",
    "            & COALESCE ( Product_Text_Fragment, \"\" )",
    "    )",
    "",
    "// 4. Conditional KPI Text Creation (NO NOMINAL VALUE):",
    "// Element A: Symbol (first in sequence)",
    "VAR Arrow_Fragment =",
    "    COALESCE ( Arrow_Symbol, \"\" )",
    "// Element B: PY Value",
    "VAR PY_Fragment =",
    "    IF (",
    "        NOT ISBLANK ( Previous_Sales_Millions ),",
    "        \"PY: \" & FORMAT ( Previous_Sales_Millions, \"#,##0.00\" ) & \"M\",",
    "        BLANK ()",
    "    )",
    "// Element C: YoY Value",
    "VAR YoY_Fragment_Text =",
    "    IF (",
    "        NOT ISBLANK ( YoY_Absolute_Change_Millions ),",
    "        \"YoY: \" & FORMAT ( YoY_Absolute_Change_Millions, \"#,##0.00\" ) & \"M\",",
    "        BLANK ()",
    "    )",
    "// Element D: Share %",
    "VAR Share_Fragment =",
    "    IF (",
    "        NOT ISBLANK ( Share_Percentage ),",
    "        FORMAT ( Share_Percentage, \"0.00%\" ),",
    "        BLANK ()",
    "    )",
    "",
    "// Concatenating values in the parenthesis: (Symbol | PY | YoY | Share)",
    "VAR Inner_KPI_Text =",
    "    /*",
    "        Complex string concatenation with conditional separators.",
    "        Adds \" | \" separators only between non-blank elements to avoid",
    "        output like \" |  | value\" when some elements are missing.",
    "        This ensures clean output regardless of which metrics are available.",
    "    */",
    "    COALESCE ( Arrow_Fragment, \"\" )",
    "        & IF (",
    "            NOT ISBLANK ( Arrow_Fragment ) && NOT ISBLANK ( PY_Fragment ),",
    "            \" | \",",
    "            BLANK ()",
    "        )",
    "        & COALESCE ( PY_Fragment, \"\" )",
    "        & IF (",
    "            NOT ISBLANK ( COALESCE ( Arrow_Fragment, PY_Fragment ) )",
    "                && NOT ISBLANK ( YoY_Fragment_Text ),",
    "            \" | \",",
    "            BLANK ()",
    "        )",
    "        & COALESCE ( YoY_Fragment_Text, \"\" )",
    "        & IF (",
    "            NOT ISBLANK ( COALESCE ( Arrow_Fragment, PY_Fragment, YoY_Fragment_Text ) )",
    "                && NOT ISBLANK ( Share_Fragment ),",
    "            \" | \",",
    "            BLANK ()",
    "        )",
    "        & COALESCE ( Share_Fragment, \"\" )",
    "",
    "VAR KPI_Text =",
    "    /*",
    "        Wraps the inner KPI text in parentheses, but only if there's current Sales data.",
    "        This ensures we don't show performance metrics when there's no underlying sales data.",
    "    */",
    "    IF ( NOT ISBLANK ( Current_Sales ), \" (\" & Inner_KPI_Text & \")\", BLANK () )",
    "",
    "RETURN",
    "    /*",
    "        Final combination: Filter description text + KPI information in parentheses.",
    "        COALESCE ensures blank values are handled gracefully in the final string.",
    "        The result provides complete context about both what is being viewed (filters)",
    "        and how it's performing (KPI metrics).",
    "    */",
    "    COALESCE ( Filter_Texts, \"\" ) & COALESCE ( KPI_Text, \"\" )"
  ],
  "displayFolder": "sales",
  "lineageTag": "4c0da3ce-ecd4-4fa6-aee9-cbf11cdb6ba9"
}